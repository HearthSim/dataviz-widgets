<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.8/d3.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v0.3.js"></script>
    <style>
      @font-face {
        font-family: Belwe;
        src: url('/fonts/belwe.ttf'), url('/fonts/belwe.woff'), url('/fonts/belwe.eot');
      }

      html, body, * {
        font-family: Belwe, sans-serif;
        box-sizing: border-box;
      }

      svg {
        display: inline-block;
      }

      .toggleview {
        background: #777;
        padding: 15px;
        font-size: 16px;
        display: inline-block;
        border-radius: 6px;
        box-shadow: #111 2px 2px 3px;
        -webkit-transition: all 0.5s;
        -o-transition: all 0.5s;
        transition: all 0.5s;

        /*float: left;*/

        cursor: pointer;
      }

      .toggleview:hover{
        box-shadow: #222 2px 2px 5px;
      }

      .toggleview:active {
        box-shadow: #000 1px 1px 1px;
      }

      .deckinfo {
        height: 0;
        overflow: hidden;
        position: absolute;
        top: 10px;
        left: 625px;
        width: 215px;
        border-radius: 6px;
        box-shadow: #111 2px 2px 3px;
        border: 2px solid #444;
        color: #EEE;
        /*background: pink;*/
      }

      .deckinfo .title {
        padding: 15px;
      }

      .deckinfo.open {
      }
    </style>
  </head>
  <body style="background: #333;">
    <div>
      <svg id="chart" width="600" height="600">

      </svg>

      <div class="deckinfo"><div class="title">Selected Deck:</div></div>
      <div class="toggleview">Chart by class</div>
    </div>

    <div id="legend" style="width:500px;margin-left:50px;">

    </div>

    <script>

    var class_enum = [
      {name: 'DRUID', color: '#ff7d0a'},
      {name: 'HUNTER', color: '#abd473'},
      {name: 'MAGE', color: '#69ccf0'},
      {name: 'PALADIN', color: '#f58cba'},
      {name: 'PRIEST', color: '#fff'},
      {name: 'ROGUE', color: '#fff569'},
      {name: 'SHAMAN', color: '#0070de'},
      {name: 'WARLOCK', color: '#9482c9'},
      {name: 'WARRIOR', color: '#c79c6e'}
    ]


    d3.csv('top_decks_24_hours.csv', function(data){
      var summary = d3.nest()
         .key(function(d) { return d.player_class;})
         .rollup(function(d) {

          return {match_count: d3.sum(d, function(g) {return g.match_count; }), win_rate: (d3.sum(d, function(g) {return (+g.win_rate) * (+g.match_count); }) / d3.sum(d, function(g) {return +g.match_count}))};
        }).entries(data).map(function (d) {
          d.match_count = d.value.match_count;
          d.win_rate = d.value.win_rate;
          d.player_class = d.key;

          delete d['key'];
          delete d['value'];

          return d;
        });

      render(data, summary);


      d3.select('.toggleview').on('click', function () {
        d3.select('.deckinfo')
          .classed('open', false)
          .transition()
          .duration(350)
          .style("height", '0px')

        if (window.viewByClass) {
          d3.select(this).text('Chart by class')
        } else {
          d3.select(this).text('Chart by deck')
        }
        window.viewByClass = !window.viewByClass;
        render(data, summary)
      })
    })

    function render(data, summary){
      var x = d3.scaleLog().domain(d3.extent(data, function(d) { return +d.match_count })).range([64, 536])
      var y = d3.scaleLinear().domain([d3.max(data, function(d) { return +d.win_rate }), d3.min(data, function(d) { return +d.win_rate })]).range([64, 536])
      // var x2 = x
      // var y2 = y
      var x2 = d3.scaleLog().domain(d3.extent(summary, function(d) { return +d.match_count })).range([64, 536])
      var y2 = d3.scaleLinear().domain([d3.max(summary, function(d) { return +d.win_rate }), d3.min(summary, function(d) { return +d.win_rate })]).range([64, 536])

      window.useY = y;
      window.useX = x;

      if (window.viewByClass) {
        window.useY = y2;
        window.useX = x2;
      }

      var halfOfDecks = d3.select("#chart")
        .selectAll('line.halfOfDecks')
        .data([{value: 0.5}])

      halfOfDecks
        .enter()
        .append('line')
        .classed('halfOfDecks', true)
        .attr("x1", useX(d3.mean(window.viewByClass? summary : data, function (d) {return +d.match_count})))
        .attr("y1", 0)
        .attr("x2", useX(d3.mean(window.viewByClass? summary : data, function (d) {return +d.match_count})))
        .attr("y2", 600)
        .style("stroke-width", 2)
        .style("stroke", "#444")

      d3.select("#chart")
        .selectAll('line.halfOfDecks')
        .data([{value: 0.5}])
        .transition()
        .duration(1000)
        .attr("x1", useX(d3.mean(window.viewByClass? summary : data, function (d) {return +d.match_count})))
        .attr("y1", 0)
        .attr("x2", useX(d3.mean(window.viewByClass? summary : data, function (d) {return +d.match_count})))
        .attr("y2", 600)


      var fiveHundred = d3.select("#chart")
        .selectAll('line.fiveHundred')
        .data([{value: 0.5}])

      fiveHundred
        .enter()
        .append('line')
        .classed('fiveHundred', true)
        .attr("x1", 0)
        .attr("y1", useY(0.5))
        .attr("x2", 600)
        .attr("y2", useY(0.5))
        .style("stroke-width", 2)
        .style("stroke", "#444")

      d3.select("#chart")
        .selectAll('line.fiveHundred')
        .data([{value: 0.5}])
        .transition()
        .duration(1000)
        .attr("x1", 0)
        .attr("y1", useY(0.5))
        .attr("x2", 600)
        .attr("y2", useY(0.5))
        .style("stroke-width", 2)
        .style("stroke", "#444")

      var deckMarks = d3.select("#chart")
      .style('border', '3px solid #444')
      .selectAll('circle.mark')
      .data(data)
      .enter()
      .append('circle')
      .classed('mark', true)
      .style("fill", function (d) { return class_enum[(+d.player_class) - 2].color })
      .style("cursor", 'pointer')
      .attr("r", 3)
      .attr("data-class", function (d) { return d.player_class })
      .attr("cx", function(d) { return x(d.match_count) })
      .attr("cy", function(d) { return y(d.win_rate) })
      .on('mouseover', function (d, i) {
        d3.select(this).transition().duration(250).attr("r", 8)
      })
      .on('mouseout', function (d, i) {
        d3.select(this).transition().duration(250).attr("r", 3)
      })
      .on('click', function (d, i) {
        console.log(d3.select('.deckinfo'))

        d3.select('.deckinfo')
          .classed('open', false)
          .transition()
          .duration(350)
          .style("height", '0px')
          .transition()
          .delay(150)
          .duration(500)
          .ease(d3.easeBounce)
          .style("height", '500px')
          .on('end', function () {
            d3.select(this).classed('open', true)
          })
      })

      if (window.viewByClass) {
        d3.select("#chart")
        .selectAll('circle.mark')
        .data(data)
        .transition()
        .delay(0)
        .duration(1500)
        .ease(d3.easeCubicInOut)
        .attr("cx", function(d) { return x2(summary.find(function (x) {return x.player_class === d.player_class}).match_count) })
        .attr("cy", function(d) { return y2(summary.find(function (x) {return x.player_class === d.player_class}).win_rate) })
      } else {
        d3.select("#chart")
        .selectAll('circle.mark')
        .data(data)
        .transition()
        .delay(0)
        .duration(1500)
        .ease(d3.easeCubicInOut)
        .attr("cx", function(d) { return x(d.match_count) })
        .attr("cy", function(d) { return y(d.win_rate) })
      }

      var classMarks = d3.select("#chart")
      .style('border', '3px solid #444')
      .selectAll('image.mark')
      .data(summary)
      .enter()
      .append('image')
      .style('opacity', 0)
      .classed('mark', true)
      // .style("fill", function (d) { return class_enum[(+d.player_class) - 2].color })
      .attr('xlink:href', function (d) {
        var i = (+d.player_class) - 2;

        var name = class_enum[i].name.toLowerCase();

        name = name.charAt(0).toUpperCase() + name.slice(1)

        return '/img/icons/Icon_'+name+'_64.png'
      })
      .attr("x", function(d) { return x2(d.match_count) - 16 })
      .attr("y", function(d) { return useY(d.win_rate) - 16 })
      .attr('height', '32px')
      .attr('width', '32px')
      .style("cursor", 'pointer')
      .attr("data-class", function (d) { return d.player_class })
      .on('mouseover', function (d, i) {
        d3.select(this).transition().duration(250).attr("width", '64px').attr("height", '64px').attr("x", x2(d.match_count) - 32).attr("y", useY(d.win_rate) - 32)

      })
      .on('mouseout', function (d, i) {
        d3.select(this).transition().duration(250).attr("width", '32px').attr("height", '32px').attr("x", x2(d.match_count) - 16).attr("y", useY(d.win_rate) - 16)
      })

    var classMarks = d3.select("#chart")
      .selectAll('image.mark')
      .data(summary)
      .transition()
      .delay(window.viewByClass? 1000 : 500)
      .duration(0)
      .attr("x", function(d) { return x2(d.match_count) - 16 })
      .attr("y", function(d) { return useY(d.win_rate) - 16 })

    var classMarks = d3.select("#chart")
      .selectAll('image.mark')
      .data(summary)
      .transition()
      .delay(window.viewByClass? 1000 : 0)
      .duration(500)
      .style('opacity', function() {
        if (window.viewByClass) {
          return 1
        } else {
          return 0
        }
      })


      var newLegends = d3.select('#legend')
        .style('display', 'flex')
        .style('flex-wrap', 'wrap')
        .style('justify-content', 'space-between')
        .selectAll('.item')
        .data(class_enum)
        .enter()
        .append('div')
        .classed('item', true)
        .style('box-shadow', '#111 1px 1px 5px')
        .style('padding', "10px")
        .style('margin', "15px")
        .style('flex', "1")
        .style('display', "inline-flex")
        .style('align-items', "center")
        .style('height', '32px')
        .style('border-radius', '6px')
        // .style('width', '100px')
        .style('text-align', 'right')
        .style('background', function (d, i) { return class_enum[i].color })
        .on('mouseover', function (d, i) {
          d3.selectAll((window.viewByClass? 'image': 'circle') + '.mark')
            .transition()
            .duration(250)
            .style('opacity', 0.1)

          d3.selectAll((window.viewByClass? 'image': 'circle') + '.mark[data-class="'+ (i + 2) +'"]')
            .transition()
            .duration(250)
            .style('opacity', 1)

        })
        .on('mouseout', function (d) {
          d3.selectAll((window.viewByClass? 'image': 'circle') + '.mark')
            .transition()
            .duration(250)
            .style('opacity', 1)
        })


      newLegends
        .append('img')
        .style('border-radius', '50%')
        .style('box-shadow', '#111 1px 1px 3px')
        .style('margin-left', '-32px')
        .style('margin-right', '5px')
        .attr('src', function (d,i) {
          var name = class_enum[i].name.toLowerCase();

          name = name.charAt(0).toUpperCase() + name.slice(1)

          return '/img/icons/Icon_'+name+'_64.png'
        })

      newLegends
        .append('div')
        .style('width', '100%')
        .style('text-transform', 'capitalize')
        .style('text-align', 'center')
        .text(function(d, i) { return class_enum[i].name.toLowerCase() })

    }


    </script>
  </body>
</html>
